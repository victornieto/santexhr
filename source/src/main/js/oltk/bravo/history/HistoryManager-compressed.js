;(function(){oltk.namespace('oltk.bravo.history');oltk.include('jquery/jquery.js');var self=oltk.bravo.history.HistoryManager={_listeners:[],_iframe:null,_hiddenField:null,_ready:false,_currentToken:'',_onReady:oltk.emptyFn,fieldId:'oltk-history-field',iframeId:'oltk-history-iframe',init:function(onReady,scope){if(typeof onReady==='function'){self._onReady=oltk.bind(onReady,scope);}
jQuery(function(){self._hiddenField=document.getElementById(self.fieldId);if(jQuery.browser.msie){self._iframe=document.getElementById(self.iframeId);}
self._startUp();});},add:function(token,preventDup){if(preventDup!==false){if(self.getToken()==token){return true;}}
if(jQuery.browser.msie){return self._updateIFrame(token);}else{top.location.hash=token;return true;}},getToken:function(){return self._ready?self._currentToken:self._getHash();},addHistoryChangeListener:function(listener){if(typeof listener!=='function'){return;}
self._listeners.push(listener);},_getHash:function(){var href=top.location.href;var i=href.indexOf('#');return i>=0?href.substr(i+1):'';},_doSave:function(){self._hiddenField.value=self._currentToken;},_handleStateChange:function(token){self._currentToken=token;for(var i=0;i<self._listeners.length;i++){self._listeners[i](token);}},_updateIFrame:function(token){var html=['<html><body><div id="state">',token,'</div></body></html>'].join('');try{var doc=self._iframe.contentWindow.document;doc.open();doc.write(html);doc.close();return true;}catch(e){return false;}},_checkIFrame:function(){if(!self._iframe.contentWindow||!self._iframe.contentWindow.document){setTimeout(self._checkIFrame,10);return;}
var doc=self._iframe.contentWindow.document;var elem=doc.getElementById('state');var token=elem?elem.innerText:'';var hash=self._getHash();setInterval(function(){doc=self._iframe.contentWindow.document;elem=doc.getElementById('state');var newToken=elem?elem.innerText:'';var newHash=self._getHash();if(newToken!==token){token=newToken;self._handleStateChange(token);top.location.hash=token;hash=token;self._doSave();}else if(newHash!==hash){hash=newHash;self._updateIFrame(newHash);}},50);self._ready=true;self._onReady(hash);},_startUp:function(){self._currentToken=self._hiddenField.value;if(jQuery.browser.msie){self._checkIFrame();}else{var hash=self._getHash();setInterval(function(){var newHash=self._getHash();if(newHash!==hash){hash=newHash;self._handleStateChange(hash);self._doSave();}},50);self._ready=true;self._onReady(hash);}}};})();